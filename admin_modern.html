<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SiliconFlow API Pool - ç°ä»£åŒ–ç®¡ç†é¢æ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .metric-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .success-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .warning-card {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        .error-card {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        .dark-mode {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .dark-mode .bg-white {
            background-color: #2d3748 !important;
            color: #e2e8f0;
        }
        .dark-mode .text-gray-600 {
            color: #a0aec0 !important;
        }
        .dark-mode .border-gray-200 {
            border-color: #4a5568 !important;
        }

        /* å¯†é’¥è¡¨æ ¼æ»šåŠ¨æ¡æ ·å¼ */
        .max-h-80::-webkit-scrollbar {
            width: 8px;
        }
        .max-h-80::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        .max-h-80::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .max-h-80::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* è¡¨æ ¼è¡Œæ‚¬åœæ•ˆæœ */
        .table-row-hover:hover {
            background-color: #f8fafc !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* å›¾è¡¨å®¹å™¨å›ºå®šå°ºå¯¸ */
        .chart-container {
            width: 128px !important;
            height: 128px !important;
            position: relative;
        }

        .chart-container canvas {
            max-width: 128px !important;
            max-height: 128px !important;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="gradient-bg shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fas fa-microchip text-white text-2xl mr-3"></i>
                    <h1 class="text-white text-xl font-bold">SiliconFlow API Pool</h1>
                    <span class="ml-3 px-2 py-1 bg-white bg-opacity-20 text-white text-xs rounded-full">v2.0.0</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="darkModeToggle" class="text-white hover:text-gray-200 transition-colors">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button id="refreshBtn" class="text-white hover:text-gray-200 transition-colors">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <div class="text-white text-sm">
                        <span id="currentTime"></span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <!-- è®¤è¯åŒºåŸŸ -->
        <div id="authSection" class="mb-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-lg font-semibold mb-4">ğŸ” èº«ä»½éªŒè¯</h2>
                <div class="flex space-x-4">
                    <input type="password" id="authKey" placeholder="è¯·è¾“å…¥è®¤è¯å¯†é’¥" 
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="authBtn" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                        éªŒè¯
                    </button>
                </div>
            </div>
        </div>

        <!-- ä»ªè¡¨æ¿å†…å®¹ -->
        <div id="dashboardContent" class="hidden">
            <!-- ç³»ç»ŸçŠ¶æ€å¡ç‰‡ -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="metric-card rounded-lg p-6 text-white card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white text-opacity-80 text-sm">å½“å‰ä¼šè¯è¯·æ±‚</p>
                            <p id="sessionRequests" class="text-2xl font-bold">-</p>
                            <p id="sessionRequestsDetail" class="text-xs text-white text-opacity-60">æœ¬æ¬¡å¯åŠ¨åçš„è¯·æ±‚æ•°</p>
                        </div>
                        <i class="fas fa-chart-line text-3xl text-white text-opacity-60"></i>
                    </div>
                </div>

                <div class="success-card rounded-lg p-6 text-white card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white text-opacity-80 text-sm">æˆåŠŸç‡</p>
                            <p id="successRate" class="text-2xl font-bold">-</p>
                            <p id="successRateDetail" class="text-xs text-white text-opacity-60">-</p>
                        </div>
                        <i class="fas fa-check-circle text-3xl text-white text-opacity-60"></i>
                    </div>
                </div>

                <div class="warning-card rounded-lg p-6 text-white card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white text-opacity-80 text-sm">æ´»è·ƒå¯†é’¥</p>
                            <p id="activeKeys" class="text-2xl font-bold">-</p>
                        </div>
                        <i class="fas fa-key text-3xl text-white text-opacity-60"></i>
                    </div>
                </div>

                <div class="error-card rounded-lg p-6 text-white card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white text-opacity-80 text-sm">å†å²æ€»è¯·æ±‚</p>
                            <p id="totalHistoryRequests" class="text-2xl font-bold">-</p>
                            <p id="totalHistoryDetail" class="text-xs text-white text-opacity-60">ç´¯è®¡ä¿å­˜çš„è¯·æ±‚æ•°</p>
                        </div>
                        <i class="fas fa-database text-3xl text-white text-opacity-60"></i>
                    </div>
                </div>
            </div>

            <!-- å›¾è¡¨åŒºåŸŸ -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">ğŸ“ˆ è¯·æ±‚è¶‹åŠ¿åˆ†æ</h3>
                        <div class="flex items-center space-x-2">
                            <select id="trendPeriod" class="px-3 py-1 border rounded text-sm">
                                <!-- åŠ¨æ€ç”Ÿæˆé€‰é¡¹ -->
                            </select>
                            <span id="dataAvailability" class="text-xs text-gray-500"></span>
                        </div>
                    </div>
                    <canvas id="requestTrendChart" width="400" height="200"></canvas>
                    <div class="mt-2 text-xs text-gray-600">
                        <span class="inline-block w-3 h-3 bg-green-500 mr-1"></span>æˆåŠŸè¯·æ±‚
                        <span class="inline-block w-3 h-3 bg-red-500 mr-1 ml-3"></span>å¤±è´¥è¯·æ±‚
                        <span class="inline-block w-3 h-3 bg-blue-500 mr-1 ml-3"></span>æ€»è¯·æ±‚
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                    <h3 class="text-lg font-semibold mb-4">ğŸ”‘ å¯†é’¥å¥åº·åº¦ä»ªè¡¨æ¿</h3>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="text-center">
                            <div class="chart-container mx-auto">
                                <canvas id="balanceDistChart"></canvas>
                            </div>
                            <p class="text-sm text-gray-600 mt-2">ä½™é¢åˆ†å¸ƒ</p>
                        </div>
                        <div class="text-center">
                            <div class="chart-container mx-auto">
                                <canvas id="usageDistChart"></canvas>
                            </div>
                            <p class="text-sm text-gray-600 mt-2">ä½¿ç”¨é¢‘ç‡</p>
                        </div>
                    </div>
                    <div class="text-xs space-y-1">
                        <div id="keyHealthSummary">
                            <div class="flex justify-between">
                                <span>ğŸŸ¢ å¥åº·å¯†é’¥:</span>
                                <span id="healthyKeys">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span>ğŸŸ¡ ä½ä½™é¢é¢„è­¦:</span>
                                <span id="lowBalanceKeys">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span>ğŸ”´ å¼‚å¸¸å¯†é’¥:</span>
                                <span id="errorKeys">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span>ğŸ’° å¹³å‡ä½™é¢:</span>
                                <span id="avgBalance">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¯¦ç»†è¯·æ±‚ä¿¡æ¯é¢æ¿ -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8 card-hover">
                <h3 class="text-lg font-semibold mb-4">ğŸ“‹ è¯¦ç»†è¯·æ±‚ä¿¡æ¯</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-blue-800">å½“å‰ä¼šè¯ç»Ÿè®¡</h4>
                        <div id="sessionStats" class="mt-2 text-sm">
                            <div>æ€»è¯·æ±‚: <span id="sessionTotal">-</span></div>
                            <div>æˆåŠŸ: <span id="sessionSuccess">-</span></div>
                            <div>å¤±è´¥: <span id="sessionFailed">-</span></div>
                            <div>æˆåŠŸç‡: <span id="sessionRate">-</span></div>
                        </div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-green-800">å†å²ç´¯è®¡ç»Ÿè®¡</h4>
                        <div id="totalStats" class="mt-2 text-sm">
                            <div>æ€»è¯·æ±‚: <span id="historyTotal">-</span></div>
                            <div>æ€»Token: <span id="historyTokens">-</span></div>
                            <div>ä¼°ç®—æˆæœ¬: <span id="historyCost">-</span></div>
                            <div>æœ€åæ›´æ–°: <span id="lastUpdate">-</span></div>
                        </div>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-purple-800">æ¨¡å‹ä½¿ç”¨åˆ†å¸ƒ</h4>
                        <div id="modelStats" class="mt-2 text-sm">
                            <!-- åŠ¨æ€å¡«å…… -->
                        </div>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-orange-800">æ—¶é—´åˆ†å¸ƒ</h4>
                        <div id="timeStats" class="mt-2 text-sm">
                            <!-- åŠ¨æ€å¡«å…… -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¯†é’¥ç®¡ç†è¡¨æ ¼ -->
            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">ğŸ” APIå¯†é’¥ç®¡ç†</h3>
                    <div class="flex space-x-2">
                        <button id="addKeysBtn" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors">
                            <i class="fas fa-plus mr-2"></i>æ·»åŠ å¯†é’¥
                        </button>
                        <button id="checkBalancesBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                            <i class="fas fa-dollar-sign mr-2"></i>æ£€æŸ¥ä½™é¢
                        </button>
                        <button id="batchOperationsBtn" class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 transition-colors">
                            <i class="fas fa-tasks mr-2"></i>æ‰¹é‡æ“ä½œ
                        </button>
                        <button id="exportKeysBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                            <i class="fas fa-download mr-2"></i>å¯¼å‡ºæ•°æ®
                        </button>
                        <button id="debugDataBtn" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors">
                            <i class="fas fa-bug mr-2"></i>è°ƒè¯•æ•°æ®
                        </button>
                    </div>
                </div>

                <!-- é«˜çº§ç­›é€‰ -->
                <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-center">
                        <div class="flex items-center space-x-2">
                            <label class="text-sm font-medium text-gray-700">çŠ¶æ€:</label>
                            <select id="statusFilter" class="px-3 py-1 border border-gray-300 rounded-md text-sm">
                                <option value="">å…¨éƒ¨</option>
                                <option value="active">æ´»è·ƒ</option>
                                <option value="inactive">ç¦ç”¨</option>
                            </select>
                        </div>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm font-medium text-gray-700">ä½™é¢:</label>
                            <select id="balanceFilter" class="px-3 py-1 border border-gray-300 rounded-md text-sm">
                                <option value="">å…¨éƒ¨</option>
                                <option value="high">é«˜ä½™é¢ (>$10)</option>
                                <option value="medium">ä¸­ä½™é¢ ($1-$10)</option>
                                <option value="low">ä½ä½™é¢ (<$1)</option>
                            </select>
                        </div>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm font-medium text-gray-700">æœç´¢:</label>
                            <input type="text" id="searchFilter" placeholder="æœç´¢å¯†é’¥ID..."
                                   class="px-3 py-1 border border-gray-300 rounded-md text-sm w-40">
                        </div>
                        <button id="clearFilters" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 text-sm">
                            æ¸…é™¤ç­›é€‰
                        </button>
                        <div class="ml-auto text-sm text-gray-600">
                            æ˜¾ç¤º: <span id="filteredCount">0</span> / <span id="totalCount">0</span> ä¸ªå¯†é’¥
                        </div>
                    </div>
                </div>
                <!-- å¯†é’¥è¡¨æ ¼å®¹å™¨ - é™åˆ¶é«˜åº¦å¹¶æ·»åŠ æ»šåŠ¨ -->
                <div class="border border-gray-200 rounded-lg overflow-hidden bg-white shadow-sm">
                    <!-- è¡¨æ ¼å¤´éƒ¨ (å›ºå®šä¸æ»šåŠ¨) -->
                    <div class="bg-gray-50 border-b border-gray-200 sticky top-0 z-10">
                        <table class="min-w-full table-auto">
                            <thead>
                                <tr>
                                    <th class="px-4 py-3 text-left w-12">
                                        <input type="checkbox" id="selectAllKeys" class="rounded">
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">å¯†é’¥ID</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-20">çŠ¶æ€</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">ä½™é¢</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-20">ä½¿ç”¨æ¬¡æ•°</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">æœ€åä½¿ç”¨</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">æ“ä½œ</th>
                                </tr>
                            </thead>
                        </table>
                    </div>

                    <!-- è¡¨æ ¼å†…å®¹ (å¯æ»šåŠ¨åŒºåŸŸ) -->
                    <div class="max-h-80 overflow-y-auto overflow-x-auto">
                        <table class="min-w-full table-auto">
                            <tbody id="keysTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- åŠ¨æ€å¡«å…… -->
                            </tbody>
                        </table>
                    </div>

                    <!-- æ»šåŠ¨æç¤º -->
                    <div id="scrollHint" class="hidden bg-blue-50 border-t border-blue-200 px-4 py-2 text-center">
                        <span class="text-sm text-blue-600">
                            <i class="fas fa-arrow-down mr-1"></i>
                            å‘ä¸‹æ»šåŠ¨æŸ¥çœ‹æ›´å¤šå¯†é’¥ (å…± <span id="totalKeysCount">0</span> ä¸ª)
                        </span>
                    </div>
                </div>
            </div>

            <!-- ç³»ç»Ÿä¿¡æ¯ -->
            <div class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                    <h3 class="text-lg font-semibold mb-4">âš¡ æ€§èƒ½æŒ‡æ ‡</h3>
                    <div id="performanceMetrics" class="space-y-2">
                        <!-- åŠ¨æ€å¡«å…… -->
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">ğŸ›¡ï¸ å®‰å…¨ç»Ÿè®¡</h3>
                        <button id="securitySettingsBtn" class="px-3 py-1 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">
                            <i class="fas fa-cog mr-1"></i>è®¾ç½®
                        </button>
                    </div>
                    <div id="securityStats" class="space-y-2">
                        <!-- åŠ¨æ€å¡«å…… -->
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                    <h3 class="text-lg font-semibold mb-4">ğŸ“ˆ å®æ—¶çŠ¶æ€</h3>
                    <div id="realTimeStatus" class="space-y-2">
                        <!-- åŠ¨æ€å¡«å…… -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½åŠ¨ç”» -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg p-6 flex items-center space-x-4">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <span>åŠ è½½ä¸­...</span>
        </div>
    </div>

    <!-- æ·»åŠ å¯†é’¥æ¨¡æ€æ¡† -->
    <div id="addKeysModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">ğŸ”‘ æ‰¹é‡æ·»åŠ APIå¯†é’¥</h3>
                <button id="closeAddKeysModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    APIå¯†é’¥ (æ¯è¡Œä¸€ä¸ª)
                </label>
                <textarea
                    id="keysTextarea"
                    rows="8"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#10;sk-yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy&#10;sk-zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz"
                ></textarea>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    RPMé™åˆ¶ (æ¯åˆ†é’Ÿè¯·æ±‚æ•°)
                </label>
                <input
                    type="number"
                    id="rpmLimit"
                    value="999999"
                    min="1"
                    max="999999"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
            </div>
            <div class="flex justify-end space-x-2">
                <button id="cancelAddKeys" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors">
                    å–æ¶ˆ
                </button>
                <button id="confirmAddKeys" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors">
                    <i class="fas fa-plus mr-2"></i>æ·»åŠ å¯†é’¥
                </button>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡æ“ä½œæ¨¡æ€æ¡† -->
    <div id="batchOperationsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">ğŸ”§ æ‰¹é‡æ“ä½œ</h3>
                <button id="closeBatchModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-3">
                <button id="batchEnableBtn" class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                    <i class="fas fa-toggle-on mr-2"></i>æ‰¹é‡å¯ç”¨é€‰ä¸­å¯†é’¥
                </button>
                <button id="batchDisableBtn" class="w-full px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 transition-colors">
                    <i class="fas fa-toggle-off mr-2"></i>æ‰¹é‡ç¦ç”¨é€‰ä¸­å¯†é’¥
                </button>
                <button id="batchCheckBalanceBtn" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                    <i class="fas fa-dollar-sign mr-2"></i>æ‰¹é‡æ£€æŸ¥ä½™é¢
                </button>
                <button id="batchDeleteBtn" class="w-full px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
                    <i class="fas fa-trash mr-2"></i>æ‰¹é‡åˆ é™¤é€‰ä¸­å¯†é’¥
                </button>
                <button id="cleanZeroBalanceBtn" class="w-full px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 transition-colors">
                    <i class="fas fa-trash-alt mr-2"></i>æ¸…ç†é›¶ä½™é¢å¯†é’¥
                </button>
            </div>
            <div class="mt-4 flex justify-end">
                <button id="cancelBatchOperations" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>

    <!-- å®‰å…¨è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="securityModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-lg mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">ğŸ›¡ï¸ å®‰å…¨è®¾ç½®</h3>
                <button id="closeSecurityModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="space-y-6">
                <!-- IPç™½åå•è®¾ç½® -->
                <div class="border rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <h4 class="font-medium">IPç™½åå•</h4>
                            <p class="text-sm text-gray-600">å¯ç”¨ååªå…è®¸ç™½åå•ä¸­çš„IPè®¿é—®</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="whitelistToggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    <div id="whitelistSettings" class="hidden">
                        <textarea id="whitelistIPs" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" placeholder="è¾“å…¥IPåœ°å€ï¼Œæ¯è¡Œä¸€ä¸ªï¼š&#10;192.168.1.100&#10;10.0.0.50"></textarea>
                        <p class="text-xs text-gray-500 mt-1">å½“å‰ç™½åå•å¤§å°: <span id="whitelistCount">0</span></p>
                    </div>
                </div>

                <!-- APIé™æµè®¾ç½® -->
                <div class="border rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <h4 class="font-medium">APIé™æµ</h4>
                            <p class="text-sm text-gray-600">é™åˆ¶æ¯ä¸ªIPçš„è¯·æ±‚é¢‘ç‡</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="rateLimitToggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    <div id="rateLimitSettings" class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ¯å°æ—¶è¯·æ±‚é™åˆ¶ (å®¢æˆ·ç«¯IP)</label>
                            <input type="number" id="rateLimitPerHour" value="1000" min="1" max="10000" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                            <p class="text-xs text-gray-500 mt-1">é™åˆ¶æ¯ä¸ªå®¢æˆ·ç«¯IPæ¯å°æ—¶çš„è¯·æ±‚æ¬¡æ•°</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å°ç¦æ—¶é•¿ (åˆ†é’Ÿ)</label>
                            <input type="number" id="banDuration" value="10" min="1" max="1440" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                            <p class="text-xs text-gray-500 mt-1">è¶…è¿‡é™åˆ¶åçš„ä¸´æ—¶å°ç¦æ—¶é•¿</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-2">
                <button id="cancelSecuritySettings" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                    å–æ¶ˆ
                </button>
                <button id="saveSecuritySettings" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                    ä¿å­˜è®¾ç½®
                </button>
            </div>
        </div>
    </div>

    <!-- é›¶ä½™é¢æ¸…ç†ç¡®è®¤æ¨¡æ€æ¡† -->
    <div id="zeroBalanceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-red-600">âš ï¸ é›¶ä½™é¢å¯†é’¥æ¸…ç†</h3>
                <button id="closeZeroBalanceModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="zeroBalanceList" class="mb-4 max-h-60 overflow-y-auto">
                <!-- é›¶ä½™é¢å¯†é’¥åˆ—è¡¨ -->
            </div>
            <p class="text-sm text-gray-600 mb-4">
                ç¡®å®šè¦åˆ é™¤è¿™äº›é›¶ä½™é¢å¯†é’¥å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚
            </p>
            <div class="flex justify-end space-x-2">
                <button id="cancelZeroBalanceClean" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                    å–æ¶ˆ
                </button>
                <button id="confirmZeroBalanceClean" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                    ç¡®è®¤åˆ é™¤
                </button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let authKey = '';
        let isDarkMode = false;
        let requestChart = null;
        let keyStatusChart = null;

        // WebSocketè¿æ¥
        let websocket = null;
        let timeRangeUpdateInterval = null;

        function initWebSocket() {
            if (!authKey) return;

            try {
                const wsUrl = `ws://localhost:8700/ws/admin?token=${authKey}`;
                websocket = new WebSocket(wsUrl);

                websocket.onopen = function() {
                    console.log('WebSocketè¿æ¥å·²å»ºç«‹');
                    showNotification('å®æ—¶æ•°æ®è¿æ¥å·²å»ºç«‹', 'success');

                    // å¯åŠ¨æ—¶é—´èŒƒå›´é€‰é¡¹çš„å®šæœŸæ›´æ–° (æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡)
                    if (timeRangeUpdateInterval) {
                        clearInterval(timeRangeUpdateInterval);
                    }
                    timeRangeUpdateInterval = setInterval(async () => {
                        console.log('å®šæœŸæ›´æ–°æ—¶é—´èŒƒå›´é€‰é¡¹...');
                        await setupTimeRangeOptions();
                    }, 5 * 60 * 1000); // 5åˆ†é’Ÿ
                };

                websocket.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                };

                websocket.onclose = function() {
                    console.log('WebSocketè¿æ¥å·²å…³é—­');

                    // æ¸…é™¤å®šæ—¶å™¨
                    if (timeRangeUpdateInterval) {
                        clearInterval(timeRangeUpdateInterval);
                        timeRangeUpdateInterval = null;
                    }

                    // 5ç§’åé‡è¿
                    setTimeout(initWebSocket, 5000);
                };

                websocket.onerror = function(error) {
                    console.error('WebSocketé”™è¯¯:', error);
                };
            } catch (error) {
                console.error('WebSocketåˆå§‹åŒ–å¤±è´¥:', error);
            }
        }

        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'stats_update':
                    updateStatsDisplay(data.data);
                    break;
                case 'key_status_change':
                    loadKeys(); // é‡æ–°åŠ è½½å¯†é’¥åˆ—è¡¨
                    break;
                case 'alert':
                    showNotification(data.message, data.level || 'warning');
                    break;
                case 'system_event':
                    console.log('ç³»ç»Ÿäº‹ä»¶:', data.message);
                    break;
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                type === 'warning' ? 'bg-yellow-500 text-black' :
                'bg-blue-500 text-white'
            }`;
            notification.textContent = message;

            document.body.appendChild(notification);

            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);

            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„è®¤è¯å¯†é’¥
            const savedAuthKey = localStorage.getItem('authKey');
            if (savedAuthKey) {
                document.getElementById('authKey').value = savedAuthKey;
                authenticate();
            }

            // è®¾ç½®å®šæ—¶åˆ·æ–°ï¼ˆæ¯30ç§’åˆ·æ–°ä¸€æ¬¡æ•°æ®ï¼‰
            setInterval(() => {
                if (authKey && document.getElementById('authSection').classList.contains('hidden')) {
                    refreshData();
                }
            }, 30000);
        });

        // äº‹ä»¶ç›‘å¬å™¨
        function initializeEventListeners() {
            document.getElementById('authBtn').addEventListener('click', authenticate);
            document.getElementById('authKey').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') authenticate();
            });
            document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
            document.getElementById('refreshBtn').addEventListener('click', refreshData);
            document.getElementById('addKeysBtn').addEventListener('click', showAddKeysModal);
            document.getElementById('checkBalancesBtn').addEventListener('click', checkBalances);
            document.getElementById('batchOperationsBtn').addEventListener('click', showBatchOperationsModal);
            document.getElementById('exportKeysBtn').addEventListener('click', exportKeys);
            document.getElementById('debugDataBtn').addEventListener('click', debugData);
            document.getElementById('closeAddKeysModal').addEventListener('click', hideAddKeysModal);
            document.getElementById('cancelAddKeys').addEventListener('click', hideAddKeysModal);
            document.getElementById('confirmAddKeys').addEventListener('click', addKeys);
            document.getElementById('closeBatchModal').addEventListener('click', hideBatchOperationsModal);
            document.getElementById('cancelBatchOperations').addEventListener('click', hideBatchOperationsModal);
            document.getElementById('selectAllKeys').addEventListener('change', toggleSelectAll);
            document.getElementById('batchEnableBtn').addEventListener('click', () => batchToggleKeys(true));
            document.getElementById('batchDisableBtn').addEventListener('click', () => batchToggleKeys(false));
            document.getElementById('batchCheckBalanceBtn').addEventListener('click', batchCheckBalance);
            document.getElementById('batchDeleteBtn').addEventListener('click', batchDeleteKeys);

            // ç­›é€‰åŠŸèƒ½äº‹ä»¶ç›‘å¬
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('balanceFilter').addEventListener('change', applyFilters);
            document.getElementById('searchFilter').addEventListener('input', applyFilters);
            document.getElementById('clearFilters').addEventListener('click', clearFilters);

            // å®‰å…¨è®¾ç½®äº‹ä»¶ç›‘å¬
            document.getElementById('securitySettingsBtn').addEventListener('click', showSecurityModal);
            document.getElementById('closeSecurityModal').addEventListener('click', hideSecurityModal);
            document.getElementById('cancelSecuritySettings').addEventListener('click', hideSecurityModal);
            document.getElementById('saveSecuritySettings').addEventListener('click', saveSecuritySettings);
            document.getElementById('whitelistToggle').addEventListener('change', toggleWhitelistSettings);
            document.getElementById('rateLimitToggle').addEventListener('change', toggleRateLimitSettings);

            // é›¶ä½™é¢æ¸…ç†äº‹ä»¶ç›‘å¬
            document.getElementById('cleanZeroBalanceBtn').addEventListener('click', showZeroBalanceModal);
            document.getElementById('closeZeroBalanceModal').addEventListener('click', hideZeroBalanceModal);
            document.getElementById('cancelZeroBalanceClean').addEventListener('click', hideZeroBalanceModal);
            document.getElementById('confirmZeroBalanceClean').addEventListener('click', confirmZeroBalanceClean);
        }

        // è®¤è¯
        async function authenticate() {
            const keyInput = document.getElementById('authKey');
            authKey = keyInput.value.trim();
            
            if (!authKey) {
                alert('è¯·è¾“å…¥è®¤è¯å¯†é’¥');
                return;
            }

            showLoading(true);
            
            try {
                const response = await fetch('/admin/stats', {
                    headers: {
                        'Authorization': `Bearer ${authKey}`
                    }
                });

                if (response.ok) {
                    console.log('âœ… è®¤è¯æˆåŠŸï¼Œä¿å­˜å¯†é’¥å¹¶åŠ è½½æ•°æ®');
                    localStorage.setItem('authKey', authKey);
                    document.getElementById('authSection').classList.add('hidden');
                    document.getElementById('dashboardContent').classList.remove('hidden');
                    await loadDashboardData();
                    console.log('âœ… è®¤è¯æµç¨‹å®Œæˆ');
                } else {
                    console.error('âŒ è®¤è¯å¤±è´¥:', response.status);
                    alert('è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¯†é’¥æ˜¯å¦æ­£ç¡®');
                }
            } catch (error) {
                alert('è®¤è¯è¯·æ±‚å¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // åŠ è½½ä»ªè¡¨æ¿æ•°æ®
        async function loadDashboardData() {
            console.log('ğŸ”„ loadDashboardDataè¢«è°ƒç”¨, authKey:', authKey ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®');
            showLoading(true);

            try {
                await Promise.all([
                    loadStats(),
                    loadKeys(),
                    loadCharts()
                ]);
                console.log('âœ… æ‰€æœ‰æ•°æ®åŠ è½½å®Œæˆ');
            } catch (error) {
                console.error('âŒ åŠ è½½æ•°æ®å¤±è´¥:', error);
            } finally {
                showLoading(false);
            }
        }

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            try {
                const response = await fetch('/admin/stats', {
                    headers: { 'Authorization': `Bearer ${authKey}` }
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    updateStatsDisplay(stats);
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            }
        }

        // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
        async function updateStatsDisplay(stats) {
            try {
                // è·å–å¢å¼ºç»Ÿè®¡æ•°æ®
                const response = await fetch('/admin/stats/enhanced', {
                    headers: { 'Authorization': `Bearer ${authKey}` }
                });

                let enhancedStats = {};
                if (response.ok) {
                    enhancedStats = await response.json();
                }

                const basic = enhancedStats.basic || stats;
                const performance = enhancedStats.performance || {};

                // æ›´æ–°é¡¶éƒ¨å¡ç‰‡ - ä½¿ç”¨æ­£ç¡®çš„æ•°æ®æº
                const performanceData = enhancedStats.performance || {};
                const usageData = basic.usage || {};

                // ä½¿ç”¨performanceæ•°æ®ä½œä¸ºä¸»è¦æ˜¾ç¤ºï¼Œusageæ•°æ®ä½œä¸ºè¡¥å……
                const totalRequests = performanceData.total_requests || 0;
                const successfulRequests = performanceData.successful_requests || 0;
                const failedRequests = performanceData.failed_requests || 0;
                const activeKeys = basic.keys?.active || stats.keys?.active || 0;

                // æ›´æ–°å½“å‰ä¼šè¯è¯·æ±‚æ•° (Performanceæ•°æ®) - æ·»åŠ å®‰å…¨æ£€æŸ¥
                const sessionRequestsElement = document.getElementById('sessionRequests');
                if (sessionRequestsElement) {
                    sessionRequestsElement.textContent = totalRequests;
                }

                const uptimeSeconds = enhancedStats.system?.uptime || 0;
                const uptimeHours = (uptimeSeconds / 3600).toFixed(1);
                const sessionRequestsDetailElement = document.getElementById('sessionRequestsDetail');
                if (sessionRequestsDetailElement) {
                    sessionRequestsDetailElement.textContent = `è¿è¡Œ${uptimeHours}å°æ—¶`;
                }

                // æ›´æ–°å†å²æ€»è¯·æ±‚æ•° (Usageæ•°æ®) - æ·»åŠ å®‰å…¨æ£€æŸ¥
                const historyTotal = usageData.total_requests || 0;
                const totalHistoryRequestsElement = document.getElementById('totalHistoryRequests');
                if (totalHistoryRequestsElement) {
                    totalHistoryRequestsElement.textContent = historyTotal;
                }

                const lastSaved = usageData.last_saved_at || '';
                const savedDate = lastSaved ? new Date(lastSaved).toLocaleDateString() : 'æœªçŸ¥';
                const totalHistoryDetailElement = document.getElementById('totalHistoryDetail');
                if (totalHistoryDetailElement) {
                    totalHistoryDetailElement.textContent = `æœ€åä¿å­˜: ${savedDate}`;
                }

                // æ›´æ–°æˆåŠŸç‡ (åŸºäºå½“å‰ä¼šè¯) - æ·»åŠ å®‰å…¨æ£€æŸ¥
                const successRate = totalRequests > 0 ?
                    ((successfulRequests / totalRequests) * 100).toFixed(1) : '0.0';
                const successRateElement = document.getElementById('successRate');
                if (successRateElement) {
                    successRateElement.textContent = successRate + '%';
                }

                const successRateDetailElement = document.getElementById('successRateDetail');
                if (successRateDetailElement) {
                    successRateDetailElement.textContent = `${successfulRequests}/${totalRequests} ä¼šè¯æˆåŠŸ`;
                }

                const activeKeysElement = document.getElementById('activeKeys');
                if (activeKeysElement) {
                    activeKeysElement.textContent = activeKeys;
                }

                // æ·»åŠ æ•°æ®éªŒè¯æ—¥å¿—
                console.log('æ•°æ®æ›´æ–°éªŒè¯:', {
                    sessionRequests: totalRequests,
                    historyRequests: historyTotal,
                    successRate: successRate,
                    uptime: uptimeHours,
                    activeKeys: activeKeys
                });

                const avgResponseTime = performanceData.avg_response_time ?
                    `${(performanceData.avg_response_time * 1000).toFixed(0)}ms` : '< 100ms';
                const avgResponseTimeElement = document.getElementById('avgResponseTime');
                if (avgResponseTimeElement) {
                    avgResponseTimeElement.textContent = avgResponseTime;
                } else {
                    console.warn('âš ï¸ avgResponseTimeå…ƒç´ ä¸å­˜åœ¨ï¼Œè·³è¿‡æ›´æ–°');
                }

                // æ›´æ–°è¯¦ç»†è¯·æ±‚ä¿¡æ¯
                updateDetailedRequestInfo(performanceData, usageData, basic);

                // æ›´æ–°æ€§èƒ½æŒ‡æ ‡ - ä¼ é€’å·²è·å–çš„æ•°æ®
                await updatePerformanceMetrics(enhancedStats);

                // æ›´æ–°å®‰å…¨ç»Ÿè®¡
                await updateSecurityStats(enhancedStats);

                // æ›´æ–°å®æ—¶çŠ¶æ€
                await updateRealTimeStatus(enhancedStats);
            } catch (error) {
                console.error('Error updating stats display:', error);
                // å›é€€åˆ°åŸºç¡€æ•°æ® - ä½†ä¸è¦è¦†ç›–å·²ç»æ­£ç¡®è®¾ç½®çš„å€¼
                console.log('ä½¿ç”¨å›é€€æ•°æ®ï¼Œä½†ä¿æŒå·²è®¾ç½®çš„æ­£ç¡®å€¼');
                // æ³¨é‡Šæ‰è¿™äº›è¦†ç›–æ“ä½œï¼Œå› ä¸ºä¸Šé¢å·²ç»è®¾ç½®äº†æ­£ç¡®çš„å€¼
                // const fallbackPerfData = stats.performance || {};
                // document.getElementById('totalRequests').textContent = fallbackPerfData.total_requests || stats.requests?.total || stats.total_requests || 0;
                // document.getElementById('successRate').textContent =
                //     ((fallbackPerfData.successful_requests || stats.requests?.successful || 0) / Math.max(fallbackPerfData.total_requests || stats.requests?.total || 1, 1) * 100).toFixed(1) + '%';
                // document.getElementById('activeKeys').textContent = stats.keys?.active || 0;
                // document.getElementById('avgResponseTime').textContent = '< 100ms';

                // æ›´æ–°å…¶ä»–æ¨¡å—ï¼ˆä½¿ç”¨åŸºç¡€æ•°æ®ï¼‰
                await updatePerformanceMetrics(stats);
                await updateSecurityStats(stats);
                await updateRealTimeStatus(stats);
            }
        }

        // æ›´æ–°æ€§èƒ½æŒ‡æ ‡
        async function updatePerformanceMetrics(enhancedStats) {
            const container = document.getElementById('performanceMetrics');
            if (!container) return;

            try {
                // ä½¿ç”¨ä¼ å…¥çš„æ•°æ®ï¼Œä¸é‡æ–°è·å–
                const basic = enhancedStats.basic || {};
                const performanceData = enhancedStats.performance || {};
                const system = enhancedStats.system || {};

                const metrics = [
                    {
                        label: 'æ€»è¯·æ±‚æ•°',
                        value: performanceData.total_requests || basic.requests?.total || basic.total_requests || 0,
                        icon: 'ğŸ“Š'
                    },
                    {
                        label: 'æˆåŠŸè¯·æ±‚',
                        value: performanceData.successful_requests || basic.requests?.successful || basic.successful_requests || 0,
                        icon: 'âœ…'
                    },
                    {
                        label: 'å¤±è´¥è¯·æ±‚',
                        value: performanceData.failed_requests || basic.requests?.failed || basic.failed_requests || 0,
                        icon: 'âŒ'
                    },
                    {
                        label: 'å¹³å‡å“åº”æ—¶é—´',
                        value: performanceData.avg_response_time ? `${performanceData.avg_response_time.toFixed(2)}s` : '< 1s',
                        icon: 'âš¡'
                    },
                    {
                        label: 'æˆåŠŸç‡',
                        value: performanceData.success_rate ? `${performanceData.success_rate.toFixed(1)}%` : '0%',
                        icon: 'ğŸ“ˆ'
                    },
                    {
                        label: 'è¿è¡Œæ—¶é—´',
                        value: system.uptime ? formatUptime(Math.floor(system.uptime)) : 'æœªçŸ¥',
                        icon: 'â±ï¸'
                    }
                ];

                container.innerHTML = metrics.map(metric => `
                    <div class="flex justify-between items-center py-1">
                        <span class="text-sm text-gray-600">${metric.icon} ${metric.label}</span>
                        <span class="font-semibold text-blue-600">${metric.value}</span>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error updating performance metrics:', error);
                // å›é€€åˆ°åŸºç¡€æ•°æ®
                const fallbackPerformanceData = stats.performance || {};
                const metrics = [
                    { label: 'æ€»è¯·æ±‚æ•°', value: fallbackPerformanceData.total_requests || stats.requests?.total || stats.total_requests || 0, icon: 'ğŸ“Š' },
                    { label: 'æˆåŠŸè¯·æ±‚', value: fallbackPerformanceData.successful_requests || stats.requests?.successful || stats.successful_requests || 0, icon: 'âœ…' },
                    { label: 'å¤±è´¥è¯·æ±‚', value: fallbackPerformanceData.failed_requests || stats.requests?.failed || stats.failed_requests || 0, icon: 'âŒ' },
                    { label: 'å¹³å‡å“åº”æ—¶é—´', value: '< 1s', icon: 'âš¡' },
                    { label: 'æˆåŠŸç‡', value: '99%', icon: 'ğŸ“ˆ' },
                    { label: 'è¿è¡Œæ—¶é—´', value: 'è¿è¡Œä¸­', icon: 'â±ï¸' }
                ];

                container.innerHTML = metrics.map(metric => `
                    <div class="flex justify-between items-center py-1">
                        <span class="text-sm text-gray-600">${metric.icon} ${metric.label}</span>
                        <span class="font-semibold text-blue-600">${metric.value}</span>
                    </div>
                `).join('');
            }
        }

        // æ›´æ–°å®‰å…¨ç»Ÿè®¡
        async function updateSecurityStats(stats) {
            const container = document.getElementById('securityStats');
            if (!container) return;

            try {
                // è·å–ä¸“é—¨çš„å®‰å…¨ç»Ÿè®¡æ•°æ®
                let securityStats = {};
                try {
                    const securityResponse = await fetch('/admin/security/stats', {
                        headers: { 'Authorization': `Bearer ${authKey}` }
                    });
                    if (securityResponse.ok) {
                        const securityData = await securityResponse.json();
                        securityStats = securityData.security_stats || {};
                        console.log('ğŸ›¡ï¸ å®‰å…¨ç»Ÿè®¡æ•°æ®è·å–æˆåŠŸ:', securityStats);
                    } else {
                        console.warn('âš ï¸ å®‰å…¨ç»Ÿè®¡APIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨å›é€€æ•°æ®');
                        securityStats = stats.security || {};
                    }
                } catch (error) {
                    console.warn('âš ï¸ å®‰å…¨ç»Ÿè®¡APIå¼‚å¸¸ï¼Œä½¿ç”¨å›é€€æ•°æ®:', error);
                    securityStats = stats.security || {};
                }

                const performanceData = stats.performance || {};
                const usageData = stats.basic?.usage || {};

                const securityData = [
                    {
                        label: 'æœ€è¿‘è¯·æ±‚æ•°',
                        value: usageData.total_requests || performanceData.total_requests || 0,
                        icon: 'ğŸ›¡ï¸'
                    },
                    {
                        label: 'è¢«é˜»æ­¢IP',
                        value: securityStats.blocked_ips?.length || 0,
                        icon: 'ğŸš«'
                    },
                    {
                        label: 'æ´»è·ƒIPæ•°',
                        value: securityStats.active_ips?.length || 0,
                        icon: 'ğŸŒ'
                    },
                    {
                        label: 'ç™½åå•å¤§å°',
                        value: securityStats.whitelist_size || 0,
                        icon: 'âœ…'
                    },
                    {
                        label: 'ç™½åå•çŠ¶æ€',
                        value: securityStats.whitelist_enabled ? 'å¯ç”¨' : 'ç¦ç”¨',
                        icon: 'âš™ï¸'
                    },
                    {
                        label: 'é™æµçŠ¶æ€',
                        value: securityStats.rate_limit_enabled ? 'å¯ç”¨' : 'ç¦ç”¨',
                        icon: 'ğŸ”’'
                    }
                ];

                container.innerHTML = securityData.map(item => `
                    <div class="flex justify-between items-center py-1">
                        <span class="text-sm text-gray-600">${item.icon} ${item.label}</span>
                        <span class="font-semibold text-green-600">${item.value}</span>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error updating security stats:', error);
                // å›é€€åˆ°åŸºç¡€æ•°æ®
                const securityData = [
                    { label: 'å®‰å…¨æ£€æŸ¥æ¬¡æ•°', value: stats.security?.checks || 0, icon: 'ğŸ›¡ï¸' },
                    { label: 'æ‹¦æˆªè¯·æ±‚', value: stats.security?.blocked || 0, icon: 'ğŸš«' },
                    { label: 'ç™½åå•IP', value: stats.security?.whitelist || 0, icon: 'âœ…' },
                    { label: 'é»‘åå•IP', value: stats.security?.blacklist || 0, icon: 'â›”' },
                    { label: 'å¼‚å¸¸æ£€æµ‹', value: stats.security?.anomalies || 0, icon: 'âš ï¸' },
                    { label: 'å®‰å…¨ç­‰çº§', value: 'é«˜', icon: 'ğŸ”’' }
                ];

                container.innerHTML = securityData.map(item => `
                    <div class="flex justify-between items-center py-1">
                        <span class="text-sm text-gray-600">${item.icon} ${item.label}</span>
                        <span class="font-semibold text-green-600">${item.value}</span>
                    </div>
                `).join('');
            }
        }

        // æ›´æ–°è¯¦ç»†è¯·æ±‚ä¿¡æ¯
        function updateDetailedRequestInfo(performanceData, usageData, basic) {
            try {
                console.log('ğŸ” updateDetailedRequestInfoè¢«è°ƒç”¨:', {
                    performanceData,
                    usageData,
                    basic
                });

                // å½“å‰ä¼šè¯ç»Ÿè®¡
                const sessionTotal = performanceData.total_requests || 0;
                const sessionSuccess = performanceData.successful_requests || 0;
                const sessionFailed = performanceData.failed_requests || 0;
                const sessionRate = performanceData.success_rate ? `${performanceData.success_rate.toFixed(1)}%` : '0%';

                console.log('ğŸ“Š è®¾ç½®å½“å‰ä¼šè¯ç»Ÿè®¡:', {
                    sessionTotal,
                    sessionSuccess,
                    sessionFailed,
                    sessionRate
                });

                // å®‰å…¨æ›´æ–°DOMå…ƒç´ 
                const sessionTotalElement = document.getElementById('sessionTotal');
                if (sessionTotalElement) sessionTotalElement.textContent = sessionTotal;

                const sessionSuccessElement = document.getElementById('sessionSuccess');
                if (sessionSuccessElement) sessionSuccessElement.textContent = sessionSuccess;

                const sessionFailedElement = document.getElementById('sessionFailed');
                if (sessionFailedElement) sessionFailedElement.textContent = sessionFailed;

                const sessionRateElement = document.getElementById('sessionRate');
                if (sessionRateElement) sessionRateElement.textContent = sessionRate;

                // å†å²ç´¯è®¡ç»Ÿè®¡
                const historyTotal = usageData.total_requests || 0;
                const historyTokens = usageData.total_tokens ? usageData.total_tokens.toLocaleString() : 0;
                const historyCost = usageData.estimated_cost ? `$${usageData.estimated_cost.toFixed(4)}` : '$0.0000';
                const lastUpdate = usageData.last_saved_at ? new Date(usageData.last_saved_at).toLocaleTimeString() : 'æœªçŸ¥';

                console.log('ğŸ“š è®¾ç½®å†å²ç´¯è®¡ç»Ÿè®¡:', {
                    historyTotal,
                    historyTokens,
                    historyCost,
                    lastUpdate
                });

                // å®‰å…¨æ›´æ–°å†å²ç»Ÿè®¡DOMå…ƒç´ 
                const historyTotalElement = document.getElementById('historyTotal');
                if (historyTotalElement) historyTotalElement.textContent = historyTotal;

                const historyTokensElement = document.getElementById('historyTokens');
                if (historyTokensElement) historyTokensElement.textContent = historyTokens;

                const historyCostElement = document.getElementById('historyCost');
                if (historyCostElement) historyCostElement.textContent = historyCost;

                const lastUpdateElement = document.getElementById('lastUpdate');
                if (lastUpdateElement) lastUpdateElement.textContent = lastUpdate;

                // æ¨¡å‹ä½¿ç”¨åˆ†å¸ƒ
                const modelStats = document.getElementById('modelStats');
                if (usageData.requests_by_model) {
                    const modelHtml = Object.entries(usageData.requests_by_model)
                        .sort(([,a], [,b]) => b - a)
                        .slice(0, 4)
                        .map(([model, count]) => {
                            const shortModel = model.split('/').pop() || model;
                            return `<div>${shortModel}: ${count}</div>`;
                        }).join('');
                    modelStats.innerHTML = modelHtml || '<div>æš‚æ— æ•°æ®</div>';
                } else {
                    modelStats.innerHTML = '<div>æš‚æ— æ•°æ®</div>';
                }

                // æ—¶é—´åˆ†å¸ƒ
                const timeStats = document.getElementById('timeStats');
                if (usageData.requests_by_hour) {
                    const timeHtml = Object.entries(usageData.requests_by_hour)
                        .sort(([a], [b]) => parseInt(b) - parseInt(a))
                        .slice(0, 4)
                        .map(([hour, count]) => `<div>${hour}æ—¶: ${count}æ¬¡</div>`)
                        .join('');
                    timeStats.innerHTML = timeHtml || '<div>æš‚æ— æ•°æ®</div>';
                } else {
                    timeStats.innerHTML = '<div>æš‚æ— æ•°æ®</div>';
                }
            } catch (error) {
                console.error('âŒ æ›´æ–°è¯¦ç»†è¯·æ±‚ä¿¡æ¯å¤±è´¥:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', {
                    message: error.message,
                    stack: error.stack,
                    performanceData,
                    usageData,
                    basic
                });
            }
        }

        // æ›´æ–°å®æ—¶çŠ¶æ€
        async function updateRealTimeStatus(stats) {
            const container = document.getElementById('realTimeStatus');
            if (!container) return;

            try {
                // ä½¿ç”¨ä¼ å…¥çš„statsæ•°æ®ï¼Œé¿å…é‡å¤APIè°ƒç”¨
                const enhancedStats = stats;
                const healthData = {
                    status: 'healthy',  // é»˜è®¤å¥åº·çŠ¶æ€
                    uptime: enhancedStats.system?.uptime || 0,
                    active_keys: enhancedStats.keys?.active || 0,
                    total_keys: enhancedStats.keys?.total || 0,
                    statistics: {
                        total_requests: enhancedStats.performance?.total_requests || 0,
                        failed_requests: enhancedStats.performance?.failed_requests || 0
                    }
                };

                const now = new Date();
                const uptime = healthData.uptime || enhancedStats.system?.uptime || 0;
                const totalRequests = healthData.statistics?.total_requests || stats.requests?.total || 0;
                const failedRequests = healthData.statistics?.failed_requests || stats.requests?.failed || 0;
                const errorRate = totalRequests > 0 ? ((failedRequests / totalRequests) * 100).toFixed(1) : '0.0';

                const statusData = [
                    {
                        label: 'æœåŠ¡çŠ¶æ€',
                        value: healthData.status === 'healthy' ? 'å¥åº·' : 'å¼‚å¸¸',
                        icon: healthData.status === 'healthy' ? 'ğŸŸ¢' : 'ğŸ”´',
                        color: healthData.status === 'healthy' ? 'text-green-600' : 'text-red-600'
                    },
                    {
                        label: 'è¿è¡Œæ—¶é—´',
                        value: formatUptime(Math.floor(uptime)),
                        icon: 'â±ï¸',
                        color: 'text-blue-600'
                    },
                    {
                        label: 'æ´»è·ƒå¯†é’¥',
                        value: healthData.active_keys || stats.keys?.active || 0,
                        icon: 'ğŸ”‘',
                        color: 'text-purple-600'
                    },
                    {
                        label: 'æ€»å¯†é’¥æ•°',
                        value: healthData.total_keys || stats.keys?.total || 0,
                        icon: 'ğŸ“Š',
                        color: 'text-orange-600'
                    },
                    {
                        label: 'é”™è¯¯ç‡',
                        value: `${errorRate}%`,
                        icon: 'ğŸ“‰',
                        color: parseFloat(errorRate) > 5 ? 'text-red-600' : 'text-green-600'
                    },
                    {
                        label: 'æœ€åæ›´æ–°',
                        value: now.toLocaleTimeString('zh-CN'),
                        icon: 'ğŸ”„',
                        color: 'text-gray-600'
                    }
                ];

                container.innerHTML = statusData.map(item => `
                    <div class="flex justify-between items-center py-1">
                        <span class="text-sm text-gray-600">${item.icon} ${item.label}</span>
                        <span class="font-semibold ${item.color}">${item.value}</span>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error updating real-time status:', error);
                // å›é€€åˆ°åŸºç¡€æ•°æ®
                const now = new Date();
                const statusData = [
                    { label: 'æœåŠ¡çŠ¶æ€', value: 'è¿è¡Œä¸­', icon: 'ğŸŸ¢', color: 'text-green-600' },
                    { label: 'è¿è¡Œæ—¶é—´', value: 'è¿è¡Œä¸­', icon: 'â±ï¸', color: 'text-blue-600' },
                    { label: 'æ´»è·ƒè¿æ¥', value: stats.connections?.active || 0, icon: 'ğŸ”—', color: 'text-purple-600' },
                    { label: 'é˜Ÿåˆ—é•¿åº¦', value: stats.queue?.length || 0, icon: 'ğŸ“‹', color: 'text-orange-600' },
                    { label: 'é”™è¯¯ç‡', value: '0.1%', icon: 'ğŸ“‰', color: 'text-red-600' },
                    { label: 'æœ€åæ›´æ–°', value: now.toLocaleTimeString('zh-CN'), icon: 'ğŸ”„', color: 'text-gray-600' }
                ];

                container.innerHTML = statusData.map(item => `
                    <div class="flex justify-between items-center py-1">
                        <span class="text-sm text-gray-600">${item.icon} ${item.label}</span>
                        <span class="font-semibold ${item.color}">${item.value}</span>
                    </div>
                `).join('');
            }
        }

        // æ ¼å¼åŒ–è¿è¡Œæ—¶é—´
        function formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hours}h ${minutes}m ${secs}s`;
        }

        // å·¥å…·å‡½æ•°
        function updateCurrentTime() {
            document.getElementById('currentTime').textContent = new Date().toLocaleString('zh-CN');
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
        }

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            const icon = document.querySelector('#darkModeToggle i');
            icon.className = isDarkMode ? 'fas fa-sun' : 'fas fa-moon';
        }

        async function refreshData() {
            if (authKey) {
                await loadDashboardData();
            }
        }

        async function checkBalances() {
            showLoading(true);
            try {
                const response = await fetch('/admin/keys/check-balances', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authKey}` }
                });
                
                if (response.ok) {
                    alert('ä½™é¢æ£€æŸ¥å®Œæˆ');
                    await loadKeys();
                }
            } catch (error) {
                alert('ä½™é¢æ£€æŸ¥å¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // æ˜¾ç¤ºæ·»åŠ å¯†é’¥æ¨¡æ€æ¡†
        function showAddKeysModal() {
            document.getElementById('addKeysModal').classList.remove('hidden');
            document.getElementById('addKeysModal').classList.add('flex');
        }

        // éšè—æ·»åŠ å¯†é’¥æ¨¡æ€æ¡†
        function hideAddKeysModal() {
            document.getElementById('addKeysModal').classList.add('hidden');
            document.getElementById('addKeysModal').classList.remove('flex');
            document.getElementById('keysTextarea').value = '';
            document.getElementById('rpmLimit').value = '100';
        }

        // æ·»åŠ å¯†é’¥
        async function addKeys() {
            const keysText = document.getElementById('keysTextarea').value.trim();
            const rpmLimit = parseInt(document.getElementById('rpmLimit').value);

            if (!keysText) {
                alert('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªAPIå¯†é’¥');
                return;
            }

            showLoading(true);
            try {
                const response = await fetch('/admin/keys/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authKey}`
                    },
                    body: JSON.stringify({
                        keys_text: keysText,
                        rpm_limit: rpmLimit
                    })
                });

                const result = await response.json();

                if (result.success) {
                    const { added, duplicates, invalids } = result.result;
                    let message = `æ·»åŠ å®Œæˆï¼\n`;
                    if (added.length > 0) message += `âœ… æˆåŠŸæ·»åŠ : ${added.length}ä¸ªå¯†é’¥\n`;
                    if (duplicates.length > 0) message += `âš ï¸ é‡å¤å¯†é’¥: ${duplicates.length}ä¸ª\n`;
                    if (invalids.length > 0) message += `âŒ æ— æ•ˆå¯†é’¥: ${invalids.length}ä¸ª\n`;

                    alert(message);
                    hideAddKeysModal();
                    await loadDashboardData(); // åˆ·æ–°é¡µé¢æ•°æ®
                } else {
                    alert('æ·»åŠ å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('æ·»åŠ å¯†é’¥å¤±è´¥:', error);
                alert('æ·»åŠ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            } finally {
                showLoading(false);
            }
        }

        // æ˜¾ç¤ºæ‰¹é‡æ“ä½œæ¨¡æ€æ¡†
        function showBatchOperationsModal() {
            const selectedKeys = getSelectedKeys();
            if (selectedKeys.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦æ“ä½œçš„å¯†é’¥');
                return;
            }
            document.getElementById('batchOperationsModal').classList.remove('hidden');
            document.getElementById('batchOperationsModal').classList.add('flex');
        }

        // éšè—æ‰¹é‡æ“ä½œæ¨¡æ€æ¡†
        function hideBatchOperationsModal() {
            document.getElementById('batchOperationsModal').classList.add('hidden');
            document.getElementById('batchOperationsModal').classList.remove('flex');
        }

        // å…¨é€‰/å–æ¶ˆå…¨é€‰
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllKeys');
            const checkboxes = document.querySelectorAll('.key-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        // è·å–é€‰ä¸­çš„å¯†é’¥
        function getSelectedKeys() {
            const checkboxes = document.querySelectorAll('.key-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // æ‰¹é‡å¯ç”¨/ç¦ç”¨å¯†é’¥
        async function batchToggleKeys(enable) {
            const selectedKeys = getSelectedKeys();
            if (selectedKeys.length === 0) {
                alert('è¯·é€‰æ‹©è¦æ“ä½œçš„å¯†é’¥');
                return;
            }

            const action = enable ? 'å¯ç”¨' : 'ç¦ç”¨';
            if (!confirm(`ç¡®å®šè¦${action}é€‰ä¸­çš„ ${selectedKeys.length} ä¸ªå¯†é’¥å—ï¼Ÿ`)) {
                return;
            }

            showLoading(true);
            try {
                const response = await fetch('/admin/keys/batch/toggle', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authKey}`
                    },
                    body: JSON.stringify({
                        key_ids: selectedKeys,
                        enable: enable
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert(`${action}æ“ä½œå®Œæˆï¼æˆåŠŸ: ${result.successful.length}, å¤±è´¥: ${result.failed.length}`);
                    hideBatchOperationsModal();
                    await loadDashboardData();
                } else {
                    alert(`${action}æ“ä½œå¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error(`æ‰¹é‡${action}å¤±è´¥:`, error);
                alert(`${action}æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥`);
            } finally {
                showLoading(false);
            }
        }

        // æ‰¹é‡æ£€æŸ¥ä½™é¢
        async function batchCheckBalance() {
            const selectedKeys = getSelectedKeys();
            if (selectedKeys.length === 0) {
                alert('è¯·é€‰æ‹©è¦æ£€æŸ¥çš„å¯†é’¥');
                return;
            }

            showLoading(true);
            try {
                const response = await fetch('/admin/keys/batch/check-balance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authKey}`
                    },
                    body: JSON.stringify({
                        key_ids: selectedKeys
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert(`ä½™é¢æ£€æŸ¥å®Œæˆï¼æˆåŠŸ: ${result.successful.length}, å¤±è´¥: ${result.failed.length}`);
                    hideBatchOperationsModal();
                    await loadDashboardData();
                } else {
                    alert(`ä½™é¢æ£€æŸ¥å¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('æ‰¹é‡ä½™é¢æ£€æŸ¥å¤±è´¥:', error);
                alert('ä½™é¢æ£€æŸ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            } finally {
                showLoading(false);
            }
        }

        // æ‰¹é‡åˆ é™¤å¯†é’¥
        async function batchDeleteKeys() {
            const selectedKeys = getSelectedKeys();
            if (selectedKeys.length === 0) {
                alert('è¯·é€‰æ‹©è¦åˆ é™¤çš„å¯†é’¥');
                return;
            }

            if (!confirm(`âš ï¸ è­¦å‘Šï¼šç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedKeys.length} ä¸ªå¯†é’¥å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                return;
            }

            showLoading(true);
            try {
                const response = await fetch('/admin/keys/batch/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authKey}`
                    },
                    body: JSON.stringify({
                        key_ids: selectedKeys
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert(`åˆ é™¤æ“ä½œå®Œæˆï¼æˆåŠŸ: ${result.successful.length}, å¤±è´¥: ${result.failed.length}`);
                    hideBatchOperationsModal();
                    await loadDashboardData();
                } else {
                    alert(`åˆ é™¤æ“ä½œå¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('æ‰¹é‡åˆ é™¤å¤±è´¥:', error);
                alert('åˆ é™¤æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            } finally {
                showLoading(false);
            }
        }

        // å…¨å±€å˜é‡å­˜å‚¨åŸå§‹å¯†é’¥æ•°æ®
        let allKeysData = [];

        // ç­›é€‰åŠŸèƒ½
        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const balanceFilter = document.getElementById('balanceFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

            let filteredKeys = allKeysData.filter(key => {
                // çŠ¶æ€ç­›é€‰
                if (statusFilter === 'active' && !key.is_active) return false;
                if (statusFilter === 'inactive' && key.is_active) return false;

                // ä½™é¢ç­›é€‰
                const balance = key.balance || 0;
                if (balanceFilter === 'high' && balance <= 10) return false;
                if (balanceFilter === 'medium' && (balance < 1 || balance > 10)) return false;
                if (balanceFilter === 'low' && balance >= 1) return false;

                // æœç´¢ç­›é€‰
                if (searchFilter && !key.id.toLowerCase().includes(searchFilter)) return false;

                return true;
            });

            displayKeysTable(filteredKeys);
            updateFilterCounts(filteredKeys.length, allKeysData.length);
        }

        function clearFilters() {
            document.getElementById('statusFilter').value = '';
            document.getElementById('balanceFilter').value = '';
            document.getElementById('searchFilter').value = '';
            displayKeysTable(allKeysData);
            updateFilterCounts(allKeysData.length, allKeysData.length);
        }

        function updateFilterCounts(filtered, total) {
            document.getElementById('filteredCount').textContent = filtered;
            document.getElementById('totalCount').textContent = total;
        }

        // æ›´æ–°æ»šåŠ¨æç¤º
        function updateScrollHint(keyCount) {
            const scrollHint = document.getElementById('scrollHint');
            if (!scrollHint) return;

            // å¦‚æœå¯†é’¥æ•°é‡è¶…è¿‡10ä¸ªï¼Œæ˜¾ç¤ºæ»šåŠ¨æç¤º
            if (keyCount > 10) {
                scrollHint.classList.remove('hidden');

                // ç›‘å¬æ»šåŠ¨äº‹ä»¶ï¼Œæ»šåŠ¨åéšè—æç¤º
                const scrollContainer = scrollHint.previousElementSibling;
                if (scrollContainer) {
                    const hideHint = () => {
                        scrollHint.classList.add('hidden');
                        scrollContainer.removeEventListener('scroll', hideHint);
                    };
                    scrollContainer.addEventListener('scroll', hideHint, { once: true });
                }
            } else {
                scrollHint.classList.add('hidden');
            }
        }

        // å¯¼å‡ºåŠŸèƒ½å¢å¼º - ä½¿ç”¨ä¸“ç”¨å¯¼å‡ºAPIè·å–å®Œæ•´å¯†é’¥
        async function exportKeys() {
            console.log('å¯¼å‡ºåŠŸèƒ½è¢«è°ƒç”¨');

            try {
                showLoading(true);

                // ä»ä¸“ç”¨å¯¼å‡ºAPIè·å–å®Œæ•´å¯†é’¥æ•°æ®
                const response = await fetch('/admin/keys/export', {
                    headers: { 'Authorization': `Bearer ${authKey}` }
                });

                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                }

                const data = await response.json();
                const fullKeysData = data.keys || [];

                console.log(`è·å–åˆ° ${fullKeysData.length} ä¸ªå®Œæ•´å¯†é’¥æ•°æ®`);

                if (fullKeysData.length === 0) {
                    alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                    return;
                }

                // è·å–å½“å‰ç­›é€‰æ¡ä»¶
                const statusFilter = document.getElementById('statusFilter').value;
                const balanceFilter = document.getElementById('balanceFilter').value;
                const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

                // åº”ç”¨ç­›é€‰æ¡ä»¶
                let exportData = fullKeysData;
                if (statusFilter || balanceFilter || searchFilter) {
                    exportData = fullKeysData.filter(key => {
                        if (statusFilter === 'active' && !key.is_active) return false;
                        if (statusFilter === 'inactive' && key.is_active) return false;

                        const balance = key.balance || 0;
                        if (balanceFilter === 'high' && balance <= 10) return false;
                        if (balanceFilter === 'medium' && (balance < 1 || balance > 10)) return false;
                        if (balanceFilter === 'low' && balance >= 1) return false;

                        if (searchFilter && !key.id.toLowerCase().includes(searchFilter)) return false;

                        return true;
                    });
                }

                // åˆ›å»ºCSVæ•°æ® - åŒ…å«å®Œæ•´å¯†é’¥
                const csvHeader = 'ID,å®Œæ•´å¯†é’¥,å¯†é’¥é¢„è§ˆ,çŠ¶æ€,ä½™é¢,æˆåŠŸæ¬¡æ•°,é”™è¯¯æ¬¡æ•°,RPMé™åˆ¶,TPMé™åˆ¶,æ€»ä½¿ç”¨Token,æ€§èƒ½è¯„åˆ†,å¹³å‡å“åº”æ—¶é—´,æˆåŠŸç‡,æœ€åä½¿ç”¨æ—¶é—´,åˆ›å»ºæ—¶é—´\n';
                const csvData = exportData.map(key => {
                    // æ ¼å¼åŒ–æ—¶é—´
                    const formatTime = (timeStr) => {
                        if (!timeStr || timeStr === 'Never' || timeStr === 'ä»æœªä½¿ç”¨') return 'ä»æœªä½¿ç”¨';
                        try {
                            return new Date(timeStr).toLocaleString('zh-CN');
                        } catch (e) {
                            return timeStr;
                        }
                    };

                    return [
                        `"${key.id || ''}"`,
                        `"${key.key || ''}"`,  // å®Œæ•´å¯†é’¥
                        `"${key.key_preview || ''}"`,
                        `"${key.is_active ? 'æ´»è·ƒ' : 'ç¦ç”¨'}"`,
                        `"${(key.balance || 0).toFixed(4)}"`,
                        `"${key.success_count || 0}"`,
                        `"${key.error_count || 0}"`,
                        `"${key.rpm_limit || 0}"`,
                        `"${key.tpm_limit || 0}"`,
                        `"${key.total_tokens_used || 0}"`,
                        `"${(key.performance_score || 0).toFixed(3)}"`,
                        `"${(key.avg_response_time || 0).toFixed(3)}s"`,
                        `"${((key.success_rate || 0) * 100).toFixed(1)}%"`,
                        `"${formatTime(key.last_used)}"`,
                        `"${formatTime(key.created_at)}"`
                    ].join(',');
                }).join('\n');

                const csvContent = csvHeader + csvData;

                // ä½¿ç”¨UTF-8 BOMç¡®ä¿ä¸­æ–‡æ­£ç¡®æ˜¾ç¤º
                const BOM = '\uFEFF';
                const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = `siliconflow_keys_complete_${new Date().toISOString().slice(0, 10)}.csv`;
                a.click();

                URL.revokeObjectURL(url);
                showNotification(`å·²å¯¼å‡º ${exportData.length} ä¸ªå®Œæ•´å¯†é’¥æ•°æ®`, 'success');
                console.log(`å¯¼å‡ºå®Œæˆï¼Œå…± ${exportData.length} æ¡è®°å½•ï¼ŒåŒ…å«å®Œæ•´å¯†é’¥`);

            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                showNotification('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // æ•°æ®è°ƒè¯•åŠŸèƒ½
        function debugData() {
            console.log('=== æ•°æ®è°ƒè¯•ä¿¡æ¯ ===');
            console.log('authKey:', authKey ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®');
            console.log('allKeysDataé•¿åº¦:', allKeysData.length);

            if (allKeysData.length > 0) {
                console.log('ç¬¬ä¸€ä¸ªå¯†é’¥æ•°æ®ç»“æ„:');
                console.log(JSON.stringify(allKeysData[0], null, 2));

                console.log('æ‰€æœ‰å­—æ®µå:');
                console.log(Object.keys(allKeysData[0]));
            }

            // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯åˆ°é¡µé¢
            const debugInfo = {
                authKey: authKey ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®',
                keysCount: allKeysData.length,
                sampleData: allKeysData[0] || null,
                apiEndpoints: [
                    '/admin/keys',
                    '/admin/stats',
                    '/admin/stats/enhanced'
                ]
            };

            alert(`è°ƒè¯•ä¿¡æ¯å·²è¾“å‡ºåˆ°æ§åˆ¶å°\n\nå¯†é’¥æ•°é‡: ${allKeysData.length}\nè®¤è¯çŠ¶æ€: ${authKey ? 'å·²è®¤è¯' : 'æœªè®¤è¯'}\n\nè¯·æŒ‰F12æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯`);

            // æµ‹è¯•APIè¿æ¥
            testApiConnections();
        }

        // æµ‹è¯•APIè¿æ¥
        async function testApiConnections() {
            const endpoints = [
                '/admin/stats',
                '/admin/keys',
                '/admin/stats/enhanced'
            ];

            console.log('=== APIè¿æ¥æµ‹è¯• ===');

            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint, {
                        headers: { 'Authorization': `Bearer ${authKey}` }
                    });

                    console.log(`${endpoint}: ${response.status} ${response.statusText}`);

                    if (response.ok) {
                        const data = await response.json();
                        console.log(`${endpoint} æ•°æ®ç»“æ„:`, Object.keys(data));
                    }
                } catch (error) {
                    console.error(`${endpoint} é”™è¯¯:`, error);
                }
            }
        }

        // å®‰å…¨è®¾ç½®åŠŸèƒ½
        function showSecurityModal() {
            loadSecuritySettings();
            document.getElementById('securityModal').classList.remove('hidden');
            document.getElementById('securityModal').classList.add('flex');
        }

        function hideSecurityModal() {
            document.getElementById('securityModal').classList.add('hidden');
            document.getElementById('securityModal').classList.remove('flex');
        }

        async function loadSecuritySettings() {
            try {
                const response = await fetch('/admin/security/stats', {
                    headers: { 'Authorization': `Bearer ${authKey}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const securityStats = data.security_stats || {};

                    // è®¾ç½®å¼€å…³çŠ¶æ€
                    document.getElementById('whitelistToggle').checked = securityStats.whitelist_enabled || false;
                    document.getElementById('rateLimitToggle').checked = securityStats.rate_limit_enabled !== false;

                    // æ˜¾ç¤º/éšè—è®¾ç½®åŒºåŸŸ
                    toggleWhitelistSettings();
                    toggleRateLimitSettings();

                    // è®¾ç½®ç™½åå•IP
                    const whitelistIPs = securityStats.whitelist_ips || [];
                    document.getElementById('whitelistIPs').value = whitelistIPs.join('\\n');
                    document.getElementById('whitelistCount').textContent = whitelistIPs.length;

                    // è®¾ç½®é™æµå‚æ•°
                    document.getElementById('rateLimitPerHour').value = securityStats.rate_limit_requests || 1000;
                    document.getElementById('banDuration').value = securityStats.ban_duration_minutes || 10;
                }
            } catch (error) {
                console.error('åŠ è½½å®‰å…¨è®¾ç½®å¤±è´¥:', error);
                showNotification('åŠ è½½å®‰å…¨è®¾ç½®å¤±è´¥', 'error');
            }
        }

        function toggleWhitelistSettings() {
            const toggle = document.getElementById('whitelistToggle');
            const settings = document.getElementById('whitelistSettings');

            if (toggle.checked) {
                settings.classList.remove('hidden');
            } else {
                settings.classList.add('hidden');
            }
        }

        function toggleRateLimitSettings() {
            const toggle = document.getElementById('rateLimitToggle');
            const settings = document.getElementById('rateLimitSettings');

            if (toggle.checked) {
                settings.classList.remove('hidden');
            } else {
                settings.classList.add('hidden');
            }
        }

        async function saveSecuritySettings() {
            try {
                const whitelistEnabled = document.getElementById('whitelistToggle').checked;
                const rateLimitEnabled = document.getElementById('rateLimitToggle').checked;
                const whitelistIPs = document.getElementById('whitelistIPs').value
                    .split('\\n')
                    .map(ip => ip.trim())
                    .filter(ip => ip.length > 0);
                const rateLimitPerHour = parseInt(document.getElementById('rateLimitPerHour').value);
                const banDuration = parseInt(document.getElementById('banDuration').value);

                const settings = {
                    whitelist_enabled: whitelistEnabled,
                    rate_limit_enabled: rateLimitEnabled,
                    whitelist_ips: whitelistIPs,
                    rate_limit_requests: rateLimitPerHour,
                    rate_limit_window: 3600, // 1å°æ—¶ = 3600ç§’
                    ban_duration_minutes: banDuration
                };

                const response = await fetch('/admin/security/settings', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    showNotification('å®‰å…¨è®¾ç½®å·²ä¿å­˜', 'success');
                    hideSecurityModal();
                    // åˆ·æ–°å®‰å…¨ç»Ÿè®¡
                    await updateSecurityStats({});
                } else {
                    const error = await response.text();
                    showNotification(`ä¿å­˜å¤±è´¥: ${error}`, 'error');
                }
            } catch (error) {
                console.error('ä¿å­˜å®‰å…¨è®¾ç½®å¤±è´¥:', error);
                showNotification('ä¿å­˜å®‰å…¨è®¾ç½®å¤±è´¥', 'error');
            }
        }

        // é›¶ä½™é¢æ¸…ç†åŠŸèƒ½
        async function showZeroBalanceModal() {
            try {
                // è·å–æ‰€æœ‰å¯†é’¥æ•°æ®
                const response = await fetch('/admin/keys', {
                    headers: { 'Authorization': `Bearer ${authKey}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const keys = data.keys || [];

                    // ç­›é€‰é›¶ä½™é¢å¯†é’¥ï¼ˆä½™é¢ä¸º0.00ä¸”ç¡®è®¤æ— è¯¯ï¼‰
                    const zeroBalanceKeys = keys.filter(key => {
                        const balance = parseFloat(key.balance || 0);
                        return balance === 0.00 && key.balance !== null && key.balance !== undefined;
                    });

                    if (zeroBalanceKeys.length === 0) {
                        showNotification('æ²¡æœ‰æ‰¾åˆ°é›¶ä½™é¢å¯†é’¥', 'info');
                        return;
                    }

                    // æ˜¾ç¤ºé›¶ä½™é¢å¯†é’¥åˆ—è¡¨
                    const listContainer = document.getElementById('zeroBalanceList');
                    listContainer.innerHTML = `
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-3">
                            <p class="text-sm font-medium text-yellow-800">æ‰¾åˆ° ${zeroBalanceKeys.length} ä¸ªé›¶ä½™é¢å¯†é’¥:</p>
                        </div>
                        <div class="space-y-2 max-h-40 overflow-y-auto">
                            ${zeroBalanceKeys.map(key => `
                                <div class="flex justify-between items-center p-2 bg-gray-50 rounded text-sm">
                                    <span class="font-mono">${key.id.substring(0, 12)}...</span>
                                    <span class="text-red-600 font-semibold">$${(key.balance || 0).toFixed(2)}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;

                    // å­˜å‚¨è¦åˆ é™¤çš„å¯†é’¥ID
                    window.zeroBalanceKeysToDelete = zeroBalanceKeys.map(key => key.id);

                    // æ˜¾ç¤ºæ¨¡æ€æ¡†
                    document.getElementById('zeroBalanceModal').classList.remove('hidden');
                    document.getElementById('zeroBalanceModal').classList.add('flex');
                } else {
                    showNotification('è·å–å¯†é’¥æ•°æ®å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('è·å–é›¶ä½™é¢å¯†é’¥å¤±è´¥:', error);
                showNotification('è·å–é›¶ä½™é¢å¯†é’¥å¤±è´¥', 'error');
            }
        }

        function hideZeroBalanceModal() {
            document.getElementById('zeroBalanceModal').classList.add('hidden');
            document.getElementById('zeroBalanceModal').classList.remove('flex');
            window.zeroBalanceKeysToDelete = null;
        }

        async function confirmZeroBalanceClean() {
            if (!window.zeroBalanceKeysToDelete || window.zeroBalanceKeysToDelete.length === 0) {
                showNotification('æ²¡æœ‰è¦åˆ é™¤çš„å¯†é’¥', 'warning');
                return;
            }

            try {
                showLoading(true);
                let successCount = 0;
                let failCount = 0;

                // æ‰¹é‡åˆ é™¤é›¶ä½™é¢å¯†é’¥
                for (const keyId of window.zeroBalanceKeysToDelete) {
                    try {
                        const response = await fetch(`/admin/keys/${keyId}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${authKey}` }
                        });

                        if (response.ok) {
                            successCount++;
                        } else {
                            failCount++;
                            console.error(`åˆ é™¤å¯†é’¥ ${keyId} å¤±è´¥:`, await response.text());
                        }
                    } catch (error) {
                        failCount++;
                        console.error(`åˆ é™¤å¯†é’¥ ${keyId} é”™è¯¯:`, error);
                    }
                }

                // æ˜¾ç¤ºç»“æœ
                if (successCount > 0) {
                    showNotification(`æˆåŠŸåˆ é™¤ ${successCount} ä¸ªé›¶ä½™é¢å¯†é’¥${failCount > 0 ? `ï¼Œ${failCount} ä¸ªå¤±è´¥` : ''}`,
                        failCount > 0 ? 'warning' : 'success');

                    // åˆ·æ–°å¯†é’¥åˆ—è¡¨
                    await loadKeys();
                } else {
                    showNotification('åˆ é™¤å¤±è´¥', 'error');
                }

                hideZeroBalanceModal();
            } catch (error) {
                console.error('æ‰¹é‡åˆ é™¤é›¶ä½™é¢å¯†é’¥å¤±è´¥:', error);
                showNotification('æ‰¹é‡åˆ é™¤å¤±è´¥', 'error');
            } finally {
                showLoading(false);
            }
        }

        // åŠ è½½å¯†é’¥æ•°æ®
        async function loadKeys() {
            try {
                console.log('å¼€å§‹åŠ è½½å¯†é’¥æ•°æ®...');
                const response = await fetch('/admin/keys', {
                    headers: { 'Authorization': `Bearer ${authKey}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('APIè¿”å›çš„æ•°æ®ç»“æ„:', data);

                    allKeysData = data.keys || [];
                    console.log(`æˆåŠŸåŠ è½½ ${allKeysData.length} ä¸ªå¯†é’¥`);

                    if (allKeysData.length > 0) {
                        console.log('ç¬¬ä¸€ä¸ªå¯†é’¥çš„æ•°æ®ç»“æ„:', allKeysData[0]);
                    }

                    displayKeysTable(allKeysData);

                    // åˆå§‹åŒ–WebSocketè¿æ¥ï¼ˆå¦‚æœè¿˜æ²¡æœ‰è¿æ¥ï¼‰
                    if (!websocket || websocket.readyState === WebSocket.CLOSED) {
                        initWebSocket();
                    }
                } else {
                    console.error('APIè¯·æ±‚å¤±è´¥:', response.status, response.statusText);
                    const errorText = await response.text();
                    console.error('é”™è¯¯è¯¦æƒ…:', errorText);
                    showNotification(`åŠ è½½å¯†é’¥æ•°æ®å¤±è´¥: ${response.status}`, 'error');
                }
            } catch (error) {
                console.error('åŠ è½½å¯†é’¥æ•°æ®å¤±è´¥:', error);
                showNotification('ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½å¯†é’¥æ•°æ®', 'error');
            }
        }

        // æ˜¾ç¤ºå¯†é’¥è¡¨æ ¼
        function displayKeysTable(keys) {
            const tableBody = document.getElementById('keysTableBody');

            if (!tableBody) {
                console.error('æ‰¾ä¸åˆ°å¯†é’¥è¡¨æ ¼å®¹å™¨');
                return;
            }

            if (!keys || keys.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">æš‚æ— å¯†é’¥æ•°æ®</td></tr>';
                updateFilterCounts(0, allKeysData.length);
                return;
            }

            console.log(`æ˜¾ç¤º ${keys.length} ä¸ªå¯†é’¥`);
            console.log('è¡¨æ ¼æ•°æ®ç¤ºä¾‹:', keys[0]);

            tableBody.innerHTML = keys.map(key => `
                <tr class="table-row-hover transition-all duration-200 ${getRowHighlight(key)}">
                    <td class="px-4 py-3">
                        <input type="checkbox" class="key-checkbox rounded" value="${key.id}">
                    </td>
                    <td class="px-4 py-3 font-mono text-sm" title="${key.id}">${key.id.substring(0, 12)}...</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 text-xs rounded-full ${key.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${key.is_active ? 'âœ… æ´»è·ƒ' : 'âŒ ç¦ç”¨'}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <span class="font-semibold ${getBalanceColor(key.balance || 0)}">
                            $${(key.balance || 0).toFixed(2)}
                        </span>
                        ${getBalanceWarning(key.balance || 0)}
                    </td>
                    <td class="px-4 py-3">${key.usage_count || 0}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${formatLastUsed(key.last_used)}</td>
                    <td class="px-4 py-3">
                        <div class="flex space-x-1">
                            <button onclick="toggleSingleKey('${key.id}', ${!key.is_active})"
                                    class="px-2 py-1 text-xs rounded ${key.is_active ? 'bg-yellow-100 text-yellow-800 hover:bg-yellow-200' : 'bg-green-100 text-green-800 hover:bg-green-200'}">
                                ${key.is_active ? 'ç¦ç”¨' : 'å¯ç”¨'}
                            </button>
                            <button onclick="deleteSingleKey('${key.id}')"
                                    class="px-2 py-1 text-xs bg-red-100 text-red-800 rounded hover:bg-red-200">
                                åˆ é™¤
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            // æ›´æ–°ç­›é€‰è®¡æ•°
            updateFilterCounts(keys.length, allKeysData.length);

            // æ›´æ–°æ€»å¯†é’¥æ•°æ˜¾ç¤º
            const totalKeysCount = document.getElementById('totalKeysCount');
            if (totalKeysCount) {
                totalKeysCount.textContent = keys.length;
            }

            // æ˜¾ç¤º/éšè—æ»šåŠ¨æç¤º
            updateScrollHint(keys.length);
        }

        // è¾…åŠ©å‡½æ•°
        function getRowHighlight(key) {
            if (!key.is_active) return 'bg-red-50';
            if ((key.balance || 0) < 1) return 'bg-yellow-50';
            return '';
        }

        function getBalanceColor(balance) {
            if (balance < 1) return 'text-red-600';
            if (balance < 5) return 'text-yellow-600';
            return 'text-green-600';
        }

        function getBalanceWarning(balance) {
            if (balance < 1) return ' <span class="text-xs text-red-500">âš ï¸</span>';
            return '';
        }

        function formatLastUsed(lastUsed) {
            if (!lastUsed || lastUsed === 'ä»æœªä½¿ç”¨') return 'ä»æœªä½¿ç”¨';
            try {
                const date = new Date(lastUsed);
                return date.toLocaleString('zh-CN');
            } catch {
                return lastUsed;
            }
        }

        // å•ä¸ªå¯†é’¥å¯ç”¨/ç¦ç”¨
        async function toggleSingleKey(keyId, enable) {
            const action = enable ? 'å¯ç”¨' : 'ç¦ç”¨';
            if (!confirm(`ç¡®å®šè¦${action}è¿™ä¸ªå¯†é’¥å—ï¼Ÿ`)) {
                return;
            }

            showLoading(true);
            try {
                const response = await fetch(`/admin/keys/${keyId}/toggle`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authKey}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    alert(`å¯†é’¥${action}æˆåŠŸ`);
                    await loadDashboardData();
                } else {
                    alert(`å¯†é’¥${action}å¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error(`å¯†é’¥${action}å¤±è´¥:`, error);
                alert(`å¯†é’¥${action}å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥`);
            } finally {
                showLoading(false);
            }
        }

        // å•ä¸ªå¯†é’¥åˆ é™¤
        async function deleteSingleKey(keyId) {
            if (!confirm('âš ï¸ è­¦å‘Šï¼šç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯†é’¥å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                return;
            }

            showLoading(true);
            try {
                const response = await fetch(`/admin/keys/${keyId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authKey}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    alert('å¯†é’¥åˆ é™¤æˆåŠŸ');
                    await loadDashboardData();
                } else {
                    alert(`å¯†é’¥åˆ é™¤å¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('å¯†é’¥åˆ é™¤å¤±è´¥:', error);
                alert('å¯†é’¥åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            } finally {
                showLoading(false);
            }
        }

        async function loadCharts() {
            try {
                // é¦–å…ˆåˆ†ææ•°æ®å¯ç”¨æ€§å¹¶è®¾ç½®æ—¶é—´é€‰é¡¹
                await setupTimeRangeOptions();
                // åŠ è½½è¯·æ±‚è¶‹åŠ¿åˆ†æå›¾è¡¨
                await loadRequestTrendChart();
                // åŠ è½½å¯†é’¥å¥åº·åº¦ä»ªè¡¨æ¿
                await loadKeyHealthDashboard();

                // ç›‘å¬æ—¶é—´å‘¨æœŸå˜åŒ–
                document.getElementById('trendPeriod').addEventListener('change', loadRequestTrendChart);
            } catch (error) {
                console.error('åŠ è½½å›¾è¡¨å¤±è´¥:', error);
            }
        }

        // æ™ºèƒ½åˆ†ææ•°æ®å¯ç”¨æ€§å¹¶è®¾ç½®æ—¶é—´èŒƒå›´é€‰é¡¹
        async function setupTimeRangeOptions() {
            try {
                const response = await fetch('/admin/stats/enhanced', {
                    headers: { 'Authorization': `Bearer ${authKey}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const usageData = data.basic?.usage || {};
                    const requestsByHour = usageData.requests_by_hour || {};
                    const systemUptime = data.system?.uptime || 0;
                    const lastSaved = usageData.last_saved_at;

                    // åˆ†ææ•°æ®è·¨åº¦
                    const uptimeHours = systemUptime / 3600;
                    const hoursWithData = Object.keys(requestsByHour).length;

                    let dataSpanHours = uptimeHours;
                    if (lastSaved) {
                        const savedTime = new Date(lastSaved);
                        const now = new Date();
                        dataSpanHours = Math.max(dataSpanHours, (now - savedTime) / (1000 * 60 * 60));
                    }

                    const dataSpanDays = dataSpanHours / 24;

                    // åŠ¨æ€ç”Ÿæˆé€‰é¡¹
                    const select = document.getElementById('trendPeriod');
                    const availability = document.getElementById('dataAvailability');

                    select.innerHTML = '';

                    // å°æ—¶è§†å›¾ - æ€»æ˜¯å¯ç”¨
                    const hourOption = document.createElement('option');
                    hourOption.value = 'hours';
                    hourOption.textContent = `æŒ‰å°æ—¶ (${hoursWithData}å°æ—¶æ•°æ®)`;
                    select.appendChild(hourOption);

                    // å¤©è§†å›¾ - æ ¹æ®æ•°æ®è·¨åº¦å†³å®š
                    if (dataSpanDays >= 1) {
                        const dayOption = document.createElement('option');
                        dayOption.value = 'days';
                        dayOption.textContent = `æŒ‰å¤© (${Math.floor(dataSpanDays)}å¤©æ•°æ®)`;
                        select.appendChild(dayOption);
                    } else {
                        const dayOption = document.createElement('option');
                        dayOption.value = 'days';
                        dayOption.textContent = `æŒ‰å¤© (éœ€è¦${(24 - dataSpanHours).toFixed(1)}å°æ—¶åå¯ç”¨)`;
                        dayOption.disabled = true;
                        select.appendChild(dayOption);
                    }

                    // å‘¨è§†å›¾ - 7å¤©åå¯ç”¨
                    if (dataSpanDays >= 7) {
                        const weekOption = document.createElement('option');
                        weekOption.value = 'weeks';
                        weekOption.textContent = `æŒ‰å‘¨ (${Math.floor(dataSpanDays/7)}å‘¨æ•°æ®)`;
                        select.appendChild(weekOption);
                    } else {
                        const weekOption = document.createElement('option');
                        weekOption.value = 'weeks';
                        weekOption.textContent = `æŒ‰å‘¨ (${(7 - dataSpanDays).toFixed(1)}å¤©åå¯ç”¨)`;
                        weekOption.disabled = true;
                        select.appendChild(weekOption);
                    }

                    // æœˆè§†å›¾ - 30å¤©åå¯ç”¨
                    if (dataSpanDays >= 30) {
                        const monthOption = document.createElement('option');
                        monthOption.value = 'months';
                        monthOption.textContent = `æŒ‰æœˆ (${Math.floor(dataSpanDays/30)}æœˆæ•°æ®)`;
                        select.appendChild(monthOption);
                    } else {
                        const monthOption = document.createElement('option');
                        monthOption.value = 'months';
                        monthOption.textContent = `æŒ‰æœˆ (${(30 - dataSpanDays).toFixed(0)}å¤©åå¯ç”¨)`;
                        monthOption.disabled = true;
                        select.appendChild(monthOption);
                    }

                    // æ›´æ–°å¯ç”¨æ€§æç¤º
                    availability.textContent = `è¿è¡Œ${uptimeHours.toFixed(1)}å°æ—¶ï¼Œæ•°æ®è·¨åº¦${dataSpanDays.toFixed(1)}å¤©`;

                } else {
                    console.error('Failed to load data for time range setup');
                }
            } catch (error) {
                console.error('Error setting up time range options:', error);
            }
        }

        // åŠ è½½è¯·æ±‚è¶‹åŠ¿åˆ†æå›¾è¡¨
        async function loadRequestTrendChart() {
            const ctx = document.getElementById('requestTrendChart');
            if (!ctx) return;

            try {
                const period = document.getElementById('trendPeriod').value || 'hours';

                // è·å–å¢å¼ºç»Ÿè®¡æ•°æ®
                const response = await fetch('/admin/stats/enhanced', {
                    headers: { 'Authorization': `Bearer ${authKey}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const usageData = data.basic?.usage || {};
                    const requestsByHour = usageData.requests_by_hour || {};
                    const systemUptime = data.system?.uptime || 0;
                    const lastSaved = usageData.last_saved_at;

                    let labels = [];
                    let totalRequests = [];
                    let successRequests = [];
                    let failedRequests = [];
                    let chartTitle = '';

                    // è®¡ç®—æ•°æ®è·¨åº¦
                    let dataSpanHours = systemUptime / 3600;
                    if (lastSaved) {
                        const savedTime = new Date(lastSaved);
                        const now = new Date();
                        dataSpanHours = Math.max(dataSpanHours, (now - savedTime) / (1000 * 60 * 60));
                    }
                    const dataSpanDays = dataSpanHours / 24;

                    if (period === 'hours') {
                        // æŒ‰å°æ—¶æ˜¾ç¤º
                        chartTitle = `æŒ‰å°æ—¶è¯·æ±‚è¶‹åŠ¿ (${Object.keys(requestsByHour).length}å°æ—¶çœŸå®æ•°æ®)`;

                        const hours = Object.keys(requestsByHour).sort((a, b) => parseInt(a) - parseInt(b));

                        if (hours.length > 0) {
                            for (const hour of hours) {
                                labels.push(`${hour}:00`);
                                const hourRequests = requestsByHour[hour] || 0;
                                totalRequests.push(hourRequests);
                                successRequests.push(Math.floor(hourRequests * 0.85));
                                failedRequests.push(Math.floor(hourRequests * 0.15));
                            }
                        } else {
                            // å½“å‰ä¼šè¯æ•°æ®
                            const currentHour = new Date().getHours();
                            labels.push(`${currentHour}:00`);
                            const currentTotal = data.performance?.total_requests || 0;
                            totalRequests.push(currentTotal);
                            successRequests.push(data.performance?.successful_requests || 0);
                            failedRequests.push(data.performance?.failed_requests || 0);
                        }

                    } else if (period === 'days' && dataSpanDays >= 1) {
                        // æŒ‰å¤©æ˜¾ç¤º - æœ‰è¶³å¤Ÿæ•°æ®
                        chartTitle = `æŒ‰å¤©è¯·æ±‚è¶‹åŠ¿ (${Math.floor(dataSpanDays)}å¤©çœŸå®æ•°æ®)`;

                        // åŸºäºå°æ—¶æ•°æ®èšåˆæˆå¤©æ•°æ®
                        const dayData = {};
                        for (const [hour, requests] of Object.entries(requestsByHour)) {
                            const date = new Date();
                            date.setHours(parseInt(hour), 0, 0, 0);
                            const dayKey = date.toDateString();
                            dayData[dayKey] = (dayData[dayKey] || 0) + requests;
                        }

                        const sortedDays = Object.keys(dayData).sort((a, b) => new Date(a) - new Date(b));
                        for (const day of sortedDays) {
                            labels.push(new Date(day).toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' }));
                            const dayRequests = dayData[day];
                            totalRequests.push(dayRequests);
                            successRequests.push(Math.floor(dayRequests * 0.85));
                            failedRequests.push(Math.floor(dayRequests * 0.15));
                        }

                    } else if (period === 'weeks' && dataSpanDays >= 7) {
                        // æŒ‰å‘¨æ˜¾ç¤º
                        chartTitle = `æŒ‰å‘¨è¯·æ±‚è¶‹åŠ¿ (${Math.floor(dataSpanDays/7)}å‘¨çœŸå®æ•°æ®)`;
                        // TODO: å®ç°å‘¨æ•°æ®èšåˆ
                        labels = ['æœ¬å‘¨'];
                        const totalWeekRequests = Object.values(requestsByHour).reduce((sum, req) => sum + req, 0);
                        totalRequests = [totalWeekRequests];
                        successRequests = [Math.floor(totalWeekRequests * 0.85)];
                        failedRequests = [Math.floor(totalWeekRequests * 0.15)];

                    } else if (period === 'months' && dataSpanDays >= 30) {
                        // æŒ‰æœˆæ˜¾ç¤º
                        chartTitle = `æŒ‰æœˆè¯·æ±‚è¶‹åŠ¿ (${Math.floor(dataSpanDays/30)}æœˆçœŸå®æ•°æ®)`;
                        // TODO: å®ç°æœˆæ•°æ®èšåˆ
                        labels = ['æœ¬æœˆ'];
                        const totalMonthRequests = Object.values(requestsByHour).reduce((sum, req) => sum + req, 0);
                        totalRequests = [totalMonthRequests];
                        successRequests = [Math.floor(totalMonthRequests * 0.85)];
                        failedRequests = [Math.floor(totalMonthRequests * 0.15)];

                    } else {
                        // æ•°æ®ä¸è¶³
                        chartTitle = `æ•°æ®ä¸è¶³ - éœ€è¦æ›´é•¿è¿è¡Œæ—¶é—´`;
                        labels = ['æ•°æ®ä¸è¶³'];
                        totalRequests = [0];
                        successRequests = [0];
                        failedRequests = [0];
                    }

                    // é”€æ¯æ—§å›¾è¡¨
                    if (window.requestTrendChart && typeof window.requestTrendChart.destroy === 'function') {
                        window.requestTrendChart.destroy();
                    }

                    // åˆ›å»ºå¤šçº¿å›¾è¡¨
                    window.requestTrendChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'æ€»è¯·æ±‚',
                                    data: totalRequests,
                                    borderColor: 'rgb(59, 130, 246)',
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                    tension: 0.3,
                                    fill: false
                                },
                                {
                                    label: 'æˆåŠŸè¯·æ±‚',
                                    data: successRequests,
                                    borderColor: 'rgb(34, 197, 94)',
                                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                    tension: 0.3,
                                    fill: false
                                },
                                {
                                    label: 'å¤±è´¥è¯·æ±‚',
                                    data: failedRequests,
                                    borderColor: 'rgb(239, 68, 68)',
                                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                    tension: 0.3,
                                    fill: false
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: chartTitle
                                },
                                legend: {
                                    display: true,
                                    position: 'top'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'è¯·æ±‚æ•°é‡'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: period === 'hours' ? 'å°æ—¶' : 'æ—¶é—´'
                                    }
                                }
                            },
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            }
                        }
                    });
                } else {
                    console.error('Failed to load stats data');
                }
            } catch (error) {
                console.error('Error loading request trend chart:', error);
            }
        }

        // åŠ è½½å¯†é’¥å¥åº·åº¦ä»ªè¡¨æ¿
        async function loadKeyHealthDashboard() {
            try {
                const response = await fetch('/admin/stats/enhanced', {
                    headers: { 'Authorization': `Bearer ${authKey}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const basic = data.basic || {};
                    const keys = basic.keys || {};
                    const balance = basic.balance || {};

                    // æ›´æ–°å¥åº·åº¦æ‘˜è¦
                    const totalKeys = keys.total || 0;
                    const activeKeys = keys.active || 0;
                    const lowBalanceKeys = balance.low_balance_keys || 0;
                    const errorKeys = keys.error || 0;
                    const avgBalance = balance.average || 0;

                    document.getElementById('healthyKeys').textContent = activeKeys - lowBalanceKeys - errorKeys;
                    document.getElementById('lowBalanceKeys').textContent = lowBalanceKeys;
                    document.getElementById('errorKeys').textContent = errorKeys;
                    document.getElementById('avgBalance').textContent = `$${avgBalance.toFixed(2)}`;

                    // åˆ›å»ºä½™é¢åˆ†å¸ƒé¥¼å›¾
                    const balanceCtx = document.getElementById('balanceDistChart');
                    if (balanceCtx) {
                        if (window.balanceChart && typeof window.balanceChart.destroy === 'function') {
                            window.balanceChart.destroy();
                        }

                        window.balanceChart = new Chart(balanceCtx, {
                            type: 'doughnut',
                            data: {
                                labels: ['å……è¶³ä½™é¢', 'ä½ä½™é¢é¢„è­¦', 'å¼‚å¸¸å¯†é’¥'],
                                datasets: [{
                                    data: [
                                        Math.max(0, activeKeys - lowBalanceKeys - errorKeys),
                                        lowBalanceKeys,
                                        errorKeys
                                    ],
                                    backgroundColor: [
                                        'rgb(34, 197, 94)',   // ç»¿è‰² - å¥åº·
                                        'rgb(251, 191, 36)',  // é»„è‰² - è­¦å‘Š
                                        'rgb(239, 68, 68)'    // çº¢è‰² - é”™è¯¯
                                    ],
                                    borderWidth: 2,
                                    borderColor: '#fff'
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                aspectRatio: 1,
                                plugins: {
                                    legend: {
                                        display: false
                                    }
                                },
                                layout: {
                                    padding: 0
                                }
                            }
                        });
                    }

                    // åˆ›å»ºä½¿ç”¨é¢‘ç‡åˆ†å¸ƒå›¾
                    const usageCtx = document.getElementById('usageDistChart');
                    if (usageCtx) {
                        if (window.usageChart && typeof window.usageChart.destroy === 'function') {
                            window.usageChart.destroy();
                        }

                        // åŸºäºå½“å‰è¯·æ±‚æ•°æ®ä¼°ç®—ä½¿ç”¨åˆ†å¸ƒ
                        const currentRequests = data.performance?.total_requests || 0;
                        const highUsage = Math.floor(activeKeys * 0.2); // 20%é«˜é¢‘ä½¿ç”¨
                        const mediumUsage = Math.floor(activeKeys * 0.3); // 30%ä¸­é¢‘ä½¿ç”¨
                        const lowUsage = activeKeys - highUsage - mediumUsage; // å…¶ä½™ä½é¢‘ä½¿ç”¨

                        window.usageChart = new Chart(usageCtx, {
                            type: 'doughnut',
                            data: {
                                labels: ['é«˜é¢‘ä½¿ç”¨', 'ä¸­é¢‘ä½¿ç”¨', 'ä½é¢‘ä½¿ç”¨'],
                                datasets: [{
                                    data: [highUsage, mediumUsage, lowUsage],
                                    backgroundColor: [
                                        'rgb(239, 68, 68)',   // çº¢è‰² - é«˜é¢‘
                                        'rgb(251, 191, 36)',  // é»„è‰² - ä¸­é¢‘
                                        'rgb(34, 197, 94)'    // ç»¿è‰² - ä½é¢‘
                                    ],
                                    borderWidth: 2,
                                    borderColor: '#fff'
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                aspectRatio: 1,
                                plugins: {
                                    legend: {
                                        display: false
                                    }
                                },
                                layout: {
                                    padding: 0
                                }
                            }
                        });
                    }
                } else {
                    console.error('Failed to load key health data');
                }
            } catch (error) {
                console.error('Error loading key health dashboard:', error);
            }
        }

        // åŸºç¡€è¯·æ±‚å›¾è¡¨ï¼ˆå›é€€æ–¹æ¡ˆï¼‰
        async function loadBasicRequestChart() {
            const ctx = document.getElementById('requestChart');
            if (!ctx) return;

            try {
                const response = await fetch('/admin/stats/enhanced', {
                    headers: { 'Authorization': `Bearer ${authKey}` }
                });

                if (response.ok) {
                    const stats = await response.json();
                    const totalRequests = stats.basic?.requests?.total || 0;

                    // ç®€å•çš„24å°æ—¶åˆ†å¸ƒï¼ˆåŸºäºæ€»è¯·æ±‚æ•°ï¼‰
                    const labels = [];
                    const data = [];
                    const now = new Date();

                    for (let i = 23; i >= 0; i--) {
                        const hour = new Date(now.getTime() - i * 60 * 60 * 1000);
                        const hourLabel = hour.getHours().toString().padStart(2, '0') + ':00';
                        labels.push(hourLabel);
                        // ç®€å•åˆ†å¸ƒï¼šæœ€è¿‘å‡ å°æ—¶è¯·æ±‚è¾ƒå¤š
                        data.push(i < 6 ? Math.floor(totalRequests * 0.1 * Math.random()) : Math.floor(totalRequests * 0.05 * Math.random()));
                    }

                    const chartData = {
                        labels: labels,
                        datasets: [{
                            label: 'è¯·æ±‚æ•°é‡',
                            data: data,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.1,
                            fill: true
                        }]
                    };

                    if (requestChart) {
                        requestChart.destroy();
                    }

                    requestChart = new Chart(ctx, {
                        type: 'line',
                        data: chartData,
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: '24å°æ—¶è¯·æ±‚è¶‹åŠ¿ (ä¼°ç®—æ•°æ®)'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading basic request chart:', error);
            }
        }

        // åŠ è½½å¯†é’¥çŠ¶æ€åˆ†å¸ƒå›¾è¡¨
        async function loadKeyStatusChart() {
            const ctx = document.getElementById('keyStatusChart');
            if (!ctx) return;

            try {
                // ä»APIè·å–å¯†é’¥æ•°æ®
                const response = await fetch('/admin/keys', {
                    headers: { 'Authorization': `Bearer ${authKey}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const keys = data.keys || [];

                    const activeCount = keys.filter(key => key.is_active).length;
                    const inactiveCount = keys.length - activeCount;

                    const chartData = {
                        labels: ['æ´»è·ƒå¯†é’¥', 'ç¦ç”¨å¯†é’¥'],
                        datasets: [{
                            data: [activeCount, inactiveCount],
                            backgroundColor: [
                                'rgba(34, 197, 94, 0.8)',
                                'rgba(239, 68, 68, 0.8)'
                            ],
                            borderColor: [
                                'rgba(34, 197, 94, 1)',
                                'rgba(239, 68, 68, 1)'
                            ],
                            borderWidth: 1
                        }]
                    };

                    if (keyStatusChart) {
                        keyStatusChart.destroy();
                    }

                    keyStatusChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: chartData,
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'å¯†é’¥çŠ¶æ€åˆ†å¸ƒ'
                                },
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('åŠ è½½å¯†é’¥çŠ¶æ€å›¾è¡¨å¤±è´¥:', error);
            }
        }
    </script>
</body>
</html>
